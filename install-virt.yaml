- name: Install virtualization
  hosts: localhost
  gather_facts: false
  tasks:

    - name: Check if virt-manager is already enabled
      ansible.builtin.shell: |
        set -o pipefail
        rpm -qa | grep -a "virt-manager" || echo "go"
      changed_when: false
      register: rpm

    - name: Install virtualization
      ansible.builtin.command: |
        dnf group install --with-optional virtualization -y
      become: true
      changed_when: true
      when: rpm.stdout == "go"

    - name: Ensure the iptables as firewall_backend
      become: true
      ansible.builtin.lineinfile:
        path: /etc/libvirt/network.conf
        regexp: '^firewall_backend'
        insertafter: '^#firewall_backend '
        line: firewall_backend = "iptables"

    - name: Enable service libvirtd
      become: true
      ansible.builtin.systemd_service:
        name: libvirtd
        enabled: true
